name: ğŸ” PR Preview Deployment

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  # ğŸš€ Deploy PR Preview
  deploy-preview:
    name: ğŸš€ Deploy PR Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build for Preview
      run: npm run build
      env:
        NODE_ENV: production
        VITE_BASE_URL: /pr-${{ github.event.pull_request.number }}/
        
    - name: ğŸš€ Deploy to Netlify (Preview)
      uses: nwtgck/actions-netlify@v2.1
      with:
        publish-dir: './dist'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: |
          ğŸ” PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
          
          **Preview URL:** ${{ steps.netlify.outputs.deploy-url }}
          
          ğŸ“‹ **Changes:**
          ${{ github.event.pull_request.body }}
          
          ğŸ”— **Compare:** ${{ github.event.pull_request.html_url }}
        alias: pr-${{ github.event.pull_request.number }}
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      id: netlify
      
    - name: ğŸ’¬ Comment PR with Preview Link
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const deployUrl = '${{ steps.netlify.outputs.deploy-url }}';
          
          const comment = `## ğŸš€ PR Preview Deployed!
          
          âœ… **Preview URL:** ${deployUrl}
          
          ### ğŸ“± Test Your Changes:
          
          | Feature | Link |
          |---------|------|
          | ğŸ  Home Page | [View](${deployUrl}) |
          | ğŸ¢ Property Listing | [View](${deployUrl}/property-listing) |
          | ğŸ¨ Portfolio Templates | [View](${deployUrl}/templates) |
          | ğŸ› ï¸ Portfolio Builder | [View](${deployUrl}/builder) |
          | ğŸ‘ï¸ Portfolio Preview | [View](${deployUrl}/preview) |
          
          ### ğŸ” Quick Checks:
          - [ ] **Responsive Design** - Test on mobile/tablet
          - [ ] **Dark Mode Toggle** - Switch between themes
          - [ ] **Property Features** - Search, filter, add properties
          - [ ] **Portfolio Creation** - Template selection and building
          - [ ] **Performance** - Page load speeds
          
          ---
          
          ğŸ¤– *This preview will be updated automatically when you push new commits.*
          `;
          
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # ğŸ§ª Visual Regression Testing
  visual-testing:
    name: ğŸ§ª Visual Regression Tests
    runs-on: ubuntu-latest
    needs: [deploy-preview]
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ–¼ï¸ Run Visual Tests with Percy
      run: npx percy exec -- npm run test:visual || echo "No visual tests configured"
      env:
        PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
      continue-on-error: true 